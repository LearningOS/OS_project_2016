# 文件系统部分调研报告

## 现有的可供参考的代码

* MIPS ucore (同时也是在上学期计原课上使用的操作系统. )

* X86 ucore (本学期使用的ucore)

* ucore plus

## 文件系统部分的主要目标

原定目标是将操作系统课程上完成的lab1到lab8的实验移植到MIPS ucore上, 当然要完成lab8, 就需要移植文件系统, 之所以选用MIPS ucore, 主要是考虑到MIPS ucore已经能在我们的thinpad上成功地运行, 这样可以省去底层的移植工作, 另外一方面, 也是因为我们在上学期已经在MIPS ucore上完成了VGA和ps2键盘的驱动. 由于移植目标是MIPS uocre, 因此我们将MIPS ucore与X86 ucore在lab1到lab8的完成度上进行了对比, 结果如下: 

### 对比结果

#### lab1

lab1中其中一个任务是要求完成中断机制, 这在MIPS ucore中已经完成. 但另一个任务, 在kernel panic状态下实现简单的debug命令, 包括kerninfo和backtrace就没有被实现, 因此我们需要在MIPS ucore当中重新加入这一功能. 

#### lab2

lab2是关于连续物理地址分配的实验, 在MIPS ucore当中已经以buddy system的形式进行了实现. 

#### lab3

lab3是关于虚拟内存管理的实验, 但在MIPS ucore当中, 并没有启动虚存, 因此也没有所谓的页面置换算法. 

#### lab4 lab5 lab6

这三个实验都与进程的调度有关, MIPS ucore中已经实现的很好. 

#### lab7

这一实验是关于进程间通信的,  在MIPS ucore当中只实现了信号量, 但没有实现管程. 

#### lab8

在MIPS ucore中已经完全地移植了现在X86 ucore当中的文件系统, 这是调研之前没有预料到的, 因此我们在文件系统方面的目标现在稍有改变. 但有关与目标的部分, 我会放在最后. 

### 现有的文件系统的局限

当前ucore中的文件系统是simple file system, 它主要有两个问题, 一是文件的大小有限制, 不能超过4MB+48KB, 但由于文件系统只是一个教学操作系统, 因此暂时不考虑大文件的储存问题, 当另一个问题就比较严重, 现有的文件系统并不能支持文件的创建和删除, 这对lab8的完成不会造成任何影响, 但会影响到远程文件的传输. 

#### 文件系统针对远程文件传输的解决方案

我们评估了如果在当前系统当中加入文件系统的工作量. 由于文件系统在本质上可以看成是一个数据库, 添加和删除必然涉及到块的分配和释放, 这个过程的处理可能会比较繁琐. 因此对于远程传输, 我们会采取在ucore编译阶段加入空文件的方法, 收到远端字节流的时候, 将字节流写入到文件当中即可. 

## 调研后文件系统目标

经过调研之后, 我们发现文件系统移植的工作实际上已经完成了, 但在设备层, 所谓的disk0其实是对ram的封装, 我们希望在ucore当中加入thinpad flash的驱动, 但在硬件上可能需要一些修改以支持flash的读写. 

### 关于实现flash驱动的基本方案

在《计算机硬件系统实验教程》当中, 有关于thinpad中flash如何使用的说明, 我们会在硬件当中加入相应的地址映射, 然后在设备层, 将ramdisk替换为flash. 
