## ThinPad ucore扩展 网络部分说明文档
by 梁泽宇（2014011381）

### 目标
修改ucore，加入网络扩展（FTP），并能够在上学期计算机组成原理课程的CPU上运行。

### 完成情况
#### 网卡驱动移植
将DM9000网卡驱动移植到了ucore上；
#### 协议栈
完成了整个TCP/IP协议栈，结合网卡驱动，可以在内核态实现FTP收/发数据包的功能；
#### 用户进程
通过增加系统调用的方式，可以在用户态运行FTP，进行文件在本地与远端之间的传输，同时实现了运行FTP的用户进程。

### 未完成的部分
#### 硬件部分
由于我上学期没有与同组其他成员一起完成计算机组成原理实验，因此对他们实现的硬件部分缺乏了解，直到最后阶段才知道该硬件部分不包含网卡，需要增加网卡的描述，然而此时已经来不及了。
#### 调试
由于缺乏硬件支持，我在ucore里进行的扩展最终无法在ThinPad上调试，因此未能实现真正的网络收发功能。

### 实现思路与细节
#### 内核态
##### 已有工作
已有工作主要包括2014年计算机组成原理挑战实验（章彦恺、周恩泽、沈光耀）中，对MIPS ucore进行的网络部分的扩展，包括DM9000网卡驱动程序以及ARP、IP、TCP等协议的简单实现（无协议栈）。
##### 思路与设计
* 对于网卡驱动程序，直接移植即可，其中用到了以太网中断号ETH_IRQ，而该中断号未定义，需要在thumips.h中定义，同时在trap中加入对该中断的处理；
* 增加TCP/IP协议栈，由底层至高层分别有三层协议：ARP && IP、TCP、FTP（原先实现时还增加了MAC层协议，但后来发现网卡驱动程序已包括对MAC层的处理，因此后来就删除了），每一层都需要实现收(recv)、发(send)两种功能。发送数据包时，将上一层处理后的数据包加入本层协议的首部，再交下一层处理（ARP && IP层交网卡驱动处理），接收数据包时，将下一层收到并处理后的数据包首部取出，验证其合法性后，去除本层协议首部，交上一层处理。
* 在TCP/IP协议栈的相邻两层之间，分别使用固定的内存空间（大小为4KB的数组）存放发送、接收时的数据包，实现各层之间的交互；
* FTP层需要完成整个FTP协议交互的流程（即整个交互流程中各种数据包的收发工作），包括建立连接、发送原始数据、收到数据包后进行下一步处理等。

#### 用户态
##### 已有工作
在我开始实现用户态的时候，同组文件系统扩展的工作已基本完成，这一点给我以启发，我决定仿照文件系统扩展的实现方式，通过增加系统调用来调用内核中的FTP。
##### 思路与设计
* 系统调用：user/libs/syscall.h中定义了用户进程需要使用的系统调用种类，这些系统调用最终在kern/syscall中进行具体的处理。我在实现时，对FTP所需的connect（建立连接）、send（发送）、recv（接收）等三个基本操作分别增加了新的系统调用；
* 用户进程：由于文件系统扩展中已经实现了文件的各种基本操作（包括打开、关闭、读、写等），因此对于要操作的文件直接在用户态使用文件系统功能，打开并提取所需内容，截取成固定大小的段后，通过系统调用交内核FTP处理。
